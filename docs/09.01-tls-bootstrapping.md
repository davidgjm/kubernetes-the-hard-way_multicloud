# TLS Bootstrapping Kubernetes Worker Nodes

## kube-apiserver configuration

### Generate bootstrap token

The bootstrap token can be created with the following command

```bash
bootstrapToken=$(openssl rand -hex 3).$(openssl rand -hex 8)
echo $bootstrapToken
```
result
```text
4ce19c.986ba874035ebac6
```

#### Create bootstrap token secret

1. Generate a new bootstrap token and update the file `configs/bootstrap-token-secret.yaml` as appropriate
2. Create the bootstrap token secret by running `kubectl apply -f configs/bootstrap-token-secret.yaml`




### Uploading token auth file
```bash
tokenFile=token-auth.conf
for controller in controller-0 controller-1 controller-2; do
  scp \
    configs/${tokenFile} \
    ${controller}:~/

  ssh ${controller} sudo chown -R root: ~/${tokenFile}
  ssh ${controller} sudo mv ~/${tokenFile} /var/lib/kubernetes/
done
```

### enable bootstrap authentication

Update the `systemd` unit file for `kube-apiserver` to enable bootstrap authentication
```bash
sudo vim /etc/systemd/system/kube-apiserver.service
```


```ini
  --enable-bootstrap-token-auth=true \
  --token-auth-file=/var/lib/kubernetes/token-auth.conf \
```

On the controller nodes, reload and restart the `kube-apiserver` systemd service.

```bash
sudo systemctl daemon-reload
sudo systemctl restart kube-apiserver.service
```


systemd unit file
```ini
[Unit]
Description=Kubernetes API Server
Documentation=https://github.com/kubernetes/kubernetes

[Service]
ExecStart=/usr/local/bin/kube-apiserver \
  --allow-privileged=true \
  --audit-log-maxage=30 \
  --audit-log-maxbackup=3 \
  --audit-log-maxsize=100 \
  --audit-log-path=/var/log/audit.log \
  --authorization-mode=Node,RBAC \
  --bind-address=0.0.0.0 \
  --client-ca-file=/var/lib/kubernetes/ca.crt \
  --enable-admission-plugins=NamespaceLifecycle,NodeRestriction,LimitRanger,ServiceAccount,DefaultStorageClass,ResourceQuota \
  --enable-bootstrap-token-auth=true \
  --token-auth-file=/var/lib/kubernetes/token-auth.conf \
  --etcd-servers=https://172.16.100.210:2379,https://172.16.100.211:2379,https://172.16.100.212:2379 \
  --etcd-cafile=/var/lib/kubernetes/ca.crt \
  --etcd-certfile=/var/lib/kubernetes/kube-api-server.crt \
  --etcd-keyfile=/var/lib/kubernetes/kube-api-server.key \
  --event-ttl=1h \
  --encryption-provider-config=/var/lib/kubernetes/encryption-config.yaml \
  --external-hostname=k8s.home.lab \
  --kubelet-certificate-authority=/var/lib/kubernetes/ca.crt \
  --kubelet-client-certificate=/var/lib/kubernetes/kube-api-server.crt \
  --kubelet-client-key=/var/lib/kubernetes/kube-api-server.key \
  --runtime-config='api/all=true' \
  --service-account-key-file=/var/lib/kubernetes/service-accounts.crt \
  --service-account-signing-key-file=/var/lib/kubernetes/service-accounts.key \
  --service-account-issuer=https://k8s.home.lab:6443 \
  --service-node-port-range=30000-32767 \
  --service-cluster-ip-range=10.32.0.0/24 \
  --tls-cert-file=/var/lib/kubernetes/kube-api-server.crt \
  --tls-private-key-file=/var/lib/kubernetes/kube-api-server.key \
  --v=3
Restart=on-failure
RestartSec=5

[Install]
WantedBy=multi-user.target
```

### Create cluster role binding for `system:bootstrappers`

You need to create a `ClusterRoleBinding` that binds the `system:bootstrappers` group to the cluster role `system:node-bootstrapper`.

```bash
kubectl apply -f configs/clusterrole-binding-kubelet-bootstrapping.yaml
```


```yaml
# enable bootstrapping nodes to create CSR
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: create-csrs-for-bootstrapping
subjects:
- kind: Group
  name: system:bootstrappers
  apiGroup: rbac.authorization.k8s.io
roleRef:
  kind: ClusterRole
  name: system:node-bootstrapper
  apiGroup: rbac.authorization.k8s.io
```

----

## kube-controller-manager configuration

https://kubernetes.io/docs/reference/access-authn-authz/kubelet-tls-bootstrapping/#kube-controller-manager-configuration



### Enable auto approval

```bash
kubectl apply -f configs/clusterrole-binding-controller-manager-approval.yaml
```


## kubelet configuration

### Generate bootstrap kubeconfig

```bash
kubectl config --kubeconfig=/var/lib/kubelet/bootstrap-kubeconfig set-cluster bootstrap --server='https://k8s.home.lab:6443' --certificate-authority=/var/lib/kubelet/pki/ca.crt
kubectl config --kubeconfig=/var/lib/kubelet/bootstrap-kubeconfig set-credentials kubelet-bootstrap --token=af304e.890977ab1fd555fd
kubectl config --kubeconfig=/var/lib/kubelet/bootstrap-kubeconfig set-context bootstrap --user=kubelet-bootstrap --cluster=bootstrap
kubectl config --kubeconfig=/var/lib/kubelet/bootstrap-kubeconfig use-context bootstrap
```

File content
```yaml
apiVersion: v1
clusters:
- cluster:
    certificate-authority: pki/ca.crt
    server: https://k8s.home.lab:6443
  name: bootstrap
contexts:
- context:
    cluster: bootstrap
    user: kubelet-bootstrap
  name: bootstrap
current-context: bootstrap
kind: Config
preferences: {}
users:
- name: kubelet-bootstrap
  user:
    token: af304e.890977ab1fd555fd
```

### Create kubelete config


`/var/lib/kubelet/kubelet-bootstrap-config.yaml`

```yaml
apiVersion: kubelet.config.k8s.io/v1beta1
kind: KubeletConfiguration
authentication:
  anonymous:
    enabled: false
  webhook:
    enabled: true
  x509:
    clientCAFile: "/var/lib/kubelet/pki/ca.crt"
cgroupDriver: systemd
containerRuntimeEndpoint: "unix:///var/run/containerd/containerd.sock"
serverTLSBootstrap: true
```

### kubelet service

#### Update kubelet service for bootstrap token support


```yaml
#/etc/systemd/system/kubelet.service
# /etc/systemd/system/multi-user.target.wants/kubelet.service
[Unit]
Description=kubelet: The Kubernetes Node Agent
Documentation=https://kubernetes.io/docs/
Wants=network-online.target
After=network-online.target

[Service]
ExecStart=/usr/bin/kubelet \
  --config=/var/lib/kubelet/kubelet-bootstrap-config.yaml \
  --bootstrap-kubeconfig="/var/lib/kubelet/bootstrap-kubeconfig" \
  --kubeconfig="/var/lib/kubelet/kubeconfig" \
  --v=2
Restart=always
StartLimitInterval=0
RestartSec=10

[Install]
WantedBy=multi-user.target

```

#### Enable kubelet service
```bash
systemctl enable kubelet
```


### kubelet serving certificate

When kubelet starts, it will generate a serving certificate for itself if the `serverTLSBootstrap` option is not set to true. 
When the `serverTLSBootstrap` option is set to true, kubelet will create a certificate signing request (CSR) and send it to the Kubernetes API server for signing. The kubelet serving CSR will not approved automatically by controller manager. Manually approve the CSR. To do this, you can use the `kubectl certificate approve` command.

```bash
kubectl get csr
kubectl certificate approve csr-<random-string>
```


```text
NAME                                                   AGE   SIGNERNAME                                    REQUESTOR                 REQUESTEDDURATION   CONDITION
csr-99blz                                              42m   kubernetes.io/kubelet-serving                 system:node:k8s-node-04   <none>              Approved,Issued
csr-9p57c                                              47m   kubernetes.io/kubelet-serving                 system:node:k8s-node-04   <none>              Pending
node-csr-iTbBDBdSddKy0J9lvAs7bDW_rRUbXWxaZcdIaAsVsks   42m   kubernetes.io/kube-apiserver-client-kubelet   system:bootstrap:af304e   <none>              Approved,Issued
```